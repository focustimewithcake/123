// netlify/functions/ai-mindmap-bot.js
const MindMapAIBot = class {
  constructor() {
    this.vietnameseStopWords = new Set([
      'v√†', 'c·ªßa', 'l√†', 'c√≥', 'ƒë∆∞·ª£c', 'trong', 'ngo√†i', 'tr√™n', 'd∆∞·ªõi', 'v·ªõi',
      'nh∆∞', 'theo', 't·ª´', 'v·ªÅ', 'sau', 'tr∆∞·ªõc', 'khi', 'n·∫øu', 'th√¨', 'm√†',
      'n√†y', 'ƒë√≥', 'kia', 'ai', 'g√¨', 'n√†o', 'sao', 'v√¨', 't·∫°i', 'do', 'b·ªüi',
      'cho', 'ƒë·∫øn', 'l√™n', 'xu·ªëng', 'ra', 'v√†o', '·ªü', 't·∫°i', 'b·∫±ng', 'ƒëang',
      's·∫Ω', 'ƒë√£', 'r·∫•t', 'qu√°', 'c≈©ng', 'v·∫´n', 'c·ª©', 'ch·ªâ', 'm·ªói', 't·ª´ng',
      'm·ªôt', 'hai', 'ba', 'b·ªën', 'nƒÉm', 'm·∫•y', 'nhi·ªÅu', '√≠t', 'c√°c', 'nh·ªØng',
      'm·ªçi', 'to√†n', 'c·∫£', 'ch√≠nh', 'ngay', 'lu√¥n', 'v·ª´a', 'm·ªõi', 'ƒë·ªÅu', 'ch∆∞a'
    ]);
  }

  generateMindMap(text, style = 'balanced', complexity = 'medium') {
    console.log('ü§ñ AI Bot ƒëang ph√¢n t√≠ch vƒÉn b·∫£n...');
    
    const cleanedText = this.cleanText(text);
    const analysis = this.analyzeText(cleanedText);
    const mindmap = this.createStructuredMindMap(analysis, style, complexity);
    
    return mindmap;
  }

  cleanText(text) {
    if (!text) return '';
    return text
      .replace(/[^\w\s√Ä√Å√Ç√É√à√â√ä√å√ç√í√ì√î√ï√ô√ö√ù√†√°√¢√£√®√©√™√¨√≠√≤√≥√¥√µ√π√∫√ΩƒÇƒÉƒêƒëƒ®ƒ©≈®≈©∆†∆°∆Ø∆∞·∫†-·ªπ]/gu, ' ')
      .replace(/\s+/g, ' ')
      .trim();
  }

  analyzeText(text) {
    console.log('üìä Ph√¢n t√≠ch c·∫•u tr√∫c vƒÉn b·∫£n...');
    
    const sentences = this.splitMeaningfulSentences(text);
    const paragraphs = this.splitParagraphs(text);
    const keyPhrases = this.extractKeyPhrases(sentences);
    const centralTopic = this.findTrueCentralTopic(sentences, keyPhrases);
    
    console.log('‚úÖ Ph√¢n t√≠ch ho√†n th√†nh:', {
      sentences: sentences.length,
      paragraphs: paragraphs.length,
      keyPhrases: keyPhrases.length,
      centralTopic: centralTopic
    });
    
    return {
      sentences,
      paragraphs,
      keyPhrases,
      centralTopic,
      totalSentences: sentences.length,
      totalParagraphs: paragraphs.length
    };
  }

  // THU·∫¨T TO√ÅN M·ªöI: T√¨m ch·ªß ƒë·ªÅ trung t√¢m th·ª±c s·ª±
  findTrueCentralTopic(sentences, keyPhrases) {
    if (!sentences || sentences.length === 0) return "N·ªôi dung ch√≠nh";
    
    // Ph√¢n t√≠ch t·∫ßn su·∫•t t·ª´ kh√≥a ƒë·ªÉ t√¨m ch·ªß ƒë·ªÅ ch√≠nh
    const wordFrequency = this.analyzeWordFrequency(sentences);
    const topKeywords = this.getTopKeywords(wordFrequency, 10);
    
    console.log('üîç Top keywords:', topKeywords);
    
    // T√¨m c√¢u ch·ª©a nhi·ªÅu t·ª´ kh√≥a quan tr·ªçng nh·∫•t
    let bestSentence = sentences[0];
    let highestScore = 0;
    
    sentences.forEach(sentence => {
      const score = this.calculateTopicScore(sentence, topKeywords);
      if (score > highestScore && sentence.length > 10 && sentence.length < 60) {
        highestScore = score;
        bestSentence = sentence;
      }
    });
    
    // R√∫t g·ªçn th√†nh ch·ªß ƒë·ªÅ ng·∫Øn g·ªçn
    const centralTopic = this.createConciseTopic(bestSentence, topKeywords);
    console.log('üéØ Central topic ƒë∆∞·ª£c ch·ªçn:', centralTopic);
    
    return centralTopic;
  }

  analyzeWordFrequency(sentences) {
    const frequency = {};
    
    sentences.forEach(sentence => {
      const words = sentence.toLowerCase().split(/\s+/);
      words.forEach(word => {
        if (word.length > 2 && !this.vietnameseStopWords.has(word)) {
          frequency[word] = (frequency[word] || 0) + 1;
        }
      });
    });
    
    return frequency;
  }

  getTopKeywords(frequency, count) {
    return Object.entries(frequency)
      .sort(([,a], [,b]) => b - a)
      .slice(0, count)
      .map(([word]) => word);
  }

  calculateTopicScore(sentence, keywords) {
    const sentenceLower = sentence.toLowerCase();
    let score = 0;
    
    keywords.forEach(keyword => {
      if (sentenceLower.includes(keyword)) {
        score += 1;
      }
    });
    
    // ∆Øu ti√™n c√¢u ng·∫Øn g·ªçn, r√µ r√†ng
    if (sentence.length >= 15 && sentence.length <= 50) {
      score += 2;
    }
    
    return score;
  }

  createConciseTopic(sentence, keywords) {
    // Lo·∫°i b·ªè t·ª´ th·ª´a, gi·ªØ l·∫°i √Ω ch√≠nh
    let topic = sentence
      .replace(/^(v√†|nh∆∞ng|tuy nhi√™n|do ƒë√≥|v√¨ v·∫≠y|ƒë·∫ßu ti√™n|th·ª© nh·∫•t|sau ƒë√≥)\s+/i, '')
      .replace(/[.!?]+$/, '')
      .trim();
    
    // ∆Øu ti√™n gi·ªØ l·∫°i c√°c t·ª´ kh√≥a quan tr·ªçng
    const words = topic.split(/\s+/);
    const importantWords = words.filter(word => 
      keywords.some(keyword => 
        word.toLowerCase().includes(keyword.toLowerCase())
      )
    );
    
    // N·∫øu c√≥ ƒë·ªß t·ª´ quan tr·ªçng, t·∫°o topic t·ª´ ch√∫ng
    if (importantWords.length >= 2) {
      topic = importantWords.slice(0, 4).join(' ');
    }
    
    // Gi·ªõi h·∫°n ƒë·ªô d√†i
    if (topic.length > 45) {
      topic = topic.substring(0, 42) + '...';
    }
    
    return this.capitalizeFirst(topic);
  }

  splitMeaningfulSentences(text) {
    if (!text) return [];
    
    return text.split(/[.!?]+/)
      .map(s => s.trim())
      .filter(s => s.length > 10 && s.length < 150)
      .slice(0, 25);
  }

  splitParagraphs(text) {
    if (!text) return [];
    
    return text.split(/\n+/)
      .map(p => p.trim())
      .filter(p => p.length > 20)
      .slice(0, 10);
  }

  extractKeyPhrases(sentences) {
    const phrases = new Set();
    
    sentences.forEach(sentence => {
      const words = sentence.split(/\s+/).filter(word => 
        word.length > 2 && !this.vietnameseStopWords.has(word.toLowerCase())
      );
      
      for (let i = 0; i < words.length - 1; i++) {
        if (i < words.length - 2) {
          const threeWordPhrase = `${words[i]} ${words[i+1]} ${words[i+2]}`;
          if (threeWordPhrase.length > 8 && threeWordPhrase.length < 35) {
            phrases.add(threeWordPhrase);
          }
        }
        
        const twoWordPhrase = `${words[i]} ${words[i+1]}`;
        if (twoWordPhrase.length > 5 && twoWordPhrase.length < 25) {
          phrases.add(twoWordPhrase);
        }
      }
    });
    
    return Array.from(phrases).slice(0, 20);
  }

  // THU·∫¨T TO√ÅN C·∫¢I TI·∫æN: T·∫°o c·∫•u tr√∫c kh√¥ng tr√πng l·∫∑p
  createStructuredMindMap(analysis, style, complexity) {
    console.log('üèóÔ∏è T·∫°o c·∫•u tr√∫c s∆° ƒë·ªì ph√¢n c·∫•p...');
    
    const centralTopic = analysis.centralTopic || this.determineCentralTopic(analysis);
    const mainThemes = this.identifyUniqueMainThemes(analysis, centralTopic);
    const structuredBranches = this.createHierarchicalBranches(analysis, mainThemes, complexity, style);
    
    const result = {
      centralTopic,
      mainBranches: structuredBranches,
      analysis: {
        totalSentences: analysis.totalSentences,
        totalParagraphs: analysis.totalParagraphs,
        mainThemes: mainThemes.slice(0, 5),
        confidence: this.calculateConfidence(analysis)
      },
      metadata: {
        generatedBy: "AI Mind Map Bot ü§ñ",
        style: style,
        complexity: complexity,
        timestamp: new Date().toISOString(),
        version: "STRUCTURED 4.0 - FIXED DUPLICATION"
      }
    };
    
    console.log('‚úÖ C·∫•u tr√∫c ph√¢n c·∫•p ho√†n th√†nh:', {
      centralTopic: result.centralTopic,
      mainThemes: result.analysis.mainThemes,
      branches: result.mainBranches.length
    });
    
    return result;
  }

  // PH∆Ø∆†NG PH√ÅP M·ªöI: X√°c ƒë·ªãnh ch·ªß ƒë·ªÅ ch√≠nh kh√¥ng tr√πng l·∫∑p
  identifyUniqueMainThemes(analysis, centralTopic) {
    const themes = new Set();
    const centralLower = centralTopic.toLowerCase();
    
    // S·ª≠ d·ª•ng c√°c ƒëo·∫°n vƒÉn l√†m ch·ªß ƒë·ªÅ ch√≠nh (lo·∫°i b·ªè tr√πng v·ªõi central topic)
    if (analysis.paragraphs && analysis.paragraphs.length > 0) {
      analysis.paragraphs.forEach(paragraph => {
        const firstSentence = paragraph.split(/[.!?]+/)[0].trim();
        if (firstSentence.length > 15 && !this.isSimilarToCentralTopic(firstSentence, centralLower)) {
          const theme = this.createThemeTitle(firstSentence);
          if (theme && !themes.has(theme)) {
            themes.add(theme);
          }
        }
      });
    }
    
    // B·ªï sung t·ª´ c√°c c·ª•m t·ª´ quan tr·ªçng (lo·∫°i b·ªè tr√πng)
    if (analysis.keyPhrases && analysis.keyPhrases.length > 0) {
      analysis.keyPhrases.forEach(phrase => {
        if (phrase.length > 8 && !this.isSimilarToCentralTopic(phrase, centralLower)) {
          const theme = this.createThemeTitle(phrase);
          if (theme && !themes.has(theme)) {
            themes.add(theme);
          }
        }
      });
    }
    
    // N·∫øu kh√¥ng ƒë·ªß ch·ªß ƒë·ªÅ, th√™m t·ª´ c√°c c√¢u quan tr·ªçng
    if (themes.size < 3 && analysis.sentences) {
      analysis.sentences.forEach(sentence => {
        if (sentence.length > 20 && !this.isSimilarToCentralTopic(sentence, centralLower)) {
          const theme = this.createThemeTitle(sentence);
          if (theme && !themes.has(theme) && themes.size < 6) {
            themes.add(theme);
          }
        }
      });
    }
    
    return Array.from(themes).slice(0, 6);
  }

  isSimilarToCentralTopic(text, centralLower) {
    const textLower = text.toLowerCase();
    const textWords = new Set(textLower.split(/\s+/));
    const centralWords = new Set(centralLower.split(/\s+/));
    
    let commonWords = 0;
    centralWords.forEach(word => {
      if (textWords.has(word) && word.length > 2) {
        commonWords++;
      }
    });
    
    // N·∫øu c√≥ qu√° nhi·ªÅu t·ª´ tr√πng nhau, coi l√† t∆∞∆°ng t·ª±
    return commonWords >= Math.min(2, centralWords.size);
  }

  createThemeTitle(text) {
    let title = text.trim();
    
    // Lo·∫°i b·ªè t·ª´ d∆∞ th·ª´a ·ªü ƒë·∫ßu
    title = title.replace(/^(v√†|nh∆∞ng|tuy nhi√™n|do ƒë√≥|v√¨ v·∫≠y|ƒë·∫ßu ti√™n|th·ª© nh·∫•t|sau ƒë√≥)\s+/i, '');
    
    // Gi·ªõi h·∫°n ƒë·ªô d√†i
    if (title.length > 30) {
      title = title.substring(0, 30) + '...';
    }
    
    return this.capitalizeFirst(title);
  }

  createHierarchicalBranches(analysis, mainThemes, complexity, style) {
    console.log('üå≥ T·∫°o c·∫•u tr√∫c ph√¢n c·∫•p cho c√°c nh√°nh...');
    
    const branchCount = this.getBranchCount(complexity);
    const branches = [];
    const usedSubTopics = new Set();
    
    // T·∫°o nh√°nh t·ª´ c√°c ch·ªß ƒë·ªÅ ch√≠nh
    mainThemes.slice(0, branchCount).forEach((theme, index) => {
      const branch = this.createBranchStructure(theme, analysis, index, style, usedSubTopics);
      if (branch && branch.subTopics.length > 0) {
        branches.push(branch);
        console.log(`‚úÖ ƒê√£ t·∫°o nh√°nh: "${branch.title}" v·ªõi ${branch.subTopics.length} subtopic`);
      }
    });
    
    return branches;
  }

  createBranchStructure(theme, analysis, index, style, usedSubTopics) {
    const branchTitle = this.formatBranchTitle(theme, style, index);
    const subTopics = this.findUniqueSubTopics(theme, analysis, usedSubTopics);
    
    if (subTopics.length === 0) {
      return null;
    }
    
    // ƒê√°nh d·∫•u c√°c subtopic ƒë√£ s·ª≠ d·ª•ng
    subTopics.forEach(topic => usedSubTopics.add(topic.toLowerCase()));
    
    return {
      title: branchTitle,
      subTopics: subTopics.slice(0, 4)
    };
  }

  // PH∆Ø∆†NG PH√ÅP M·ªöI: T√¨m subtopic kh√¥ng tr√πng l·∫∑p
  findUniqueSubTopics(theme, analysis, usedSubTopics) {
    const subTopics = [];
    const themeLower = theme.toLowerCase();
    
    // T√¨m c√°c c√¢u li√™n quan ƒë·∫øn ch·ªß ƒë·ªÅ nh∆∞ng ch∆∞a ƒë∆∞·ª£c s·ª≠ d·ª•ng
    if (analysis.sentences) {
      analysis.sentences.forEach(sentence => {
        const sentenceLower = sentence.toLowerCase();
        
        if (this.calculateRelevance(sentenceLower, themeLower) > 0.3) {
          const cleanSubTopic = this.cleanSubTopic(sentence);
          if (cleanSubTopic && 
              !usedSubTopics.has(cleanSubTopic.toLowerCase()) &&
              !this.isTooSimilar(cleanSubTopic, themeLower)) {
            subTopics.push(cleanSubTopic);
            usedSubTopics.add(cleanSubTopic.toLowerCase());
          }
        }
      });
    }
    
    // B·ªï sung t·ª´ c√°c c·ª•m t·ª´ li√™n quan ch∆∞a ƒë∆∞·ª£c s·ª≠ d·ª•ng
    if (analysis.keyPhrases) {
      analysis.keyPhrases.forEach(phrase => {
        const phraseLower = phrase.toLowerCase();
        if (this.calculateRelevance(phraseLower, themeLower) > 0.4 && 
            phrase.length > 10 &&
            !usedSubTopics.has(phraseLower) &&
            !this.isTooSimilar(phrase, themeLower)) {
          subTopics.push(phrase);
          usedSubTopics.add(phraseLower);
        }
      });
    }
    
    return subTopics.slice(0, 6);
  }

  isTooSimilar(text, theme) {
    const textLower = text.toLowerCase();
    const textWords = new Set(textLower.split(/\s+/));
    const themeWords = new Set(theme.split(/\s+/));
    
    let commonWords = 0;
    themeWords.forEach(word => {
      if (textWords.has(word) && word.length > 2) {
        commonWords++;
      }
    });
    
    // N·∫øu qu√° gi·ªëng (tr√™n 50% t·ª´ kh·ªõp), coi l√† qu√° t∆∞∆°ng t·ª±
    return commonWords >= Math.ceil(themeWords.size * 0.5);
  }

  formatBranchTitle(theme, style, index) {
    const stylePrefixes = {
      'academic': ['Ph√¢n t√≠ch', 'Nghi√™n c·ª©u', 'Kh√°i ni·ªám', '·ª®ng d·ª•ng', 'L√Ω thuy·∫øt'],
      'creative': ['√ù t∆∞·ªüng', 'Gi·∫£i ph√°p', 'Ph√°t tri·ªÉn', 'S√°ng t·∫°o', 'ƒê·ªïi m·ªõi'],
      'business': ['Chi·∫øn l∆∞·ª£c', 'K·∫ø ho·∫°ch', 'Gi·∫£i ph√°p', 'Tri·ªÉn khai', 'Ph√°t tri·ªÉn'],
      'balanced': ['Kh√≠a c·∫°nh', 'G√≥c nh√¨n', 'Ph∆∞∆°ng di·ªán', '·ª®ng d·ª•ng', 'Quan ƒëi·ªÉm']
    };
    
    const prefixes = stylePrefixes[style] || stylePrefixes.balanced;
    const prefix = prefixes[index % prefixes.length];
    
    return `${prefix}: ${theme}`;
  }

  calculateRelevance(text, theme) {
    const textWords = new Set(text.split(/\s+/));
    const themeWords = new Set(theme.split(/\s+/));
    
    let commonWords = 0;
    themeWords.forEach(word => {
      if (textWords.has(word) && word.length > 2) {
        commonWords++;
      }
    });
    
    return commonWords / Math.max(themeWords.size, 1);
  }

  cleanSubTopic(text) {
    let cleanText = text.trim();
    
    cleanText = cleanText.replace(/^(c√≥ th·ªÉ|ƒë∆∞·ª£c|l√†|c·ªßa|trong)\s+/i, '');
    
    if (cleanText.length > 55) {
      cleanText = cleanText.substring(0, 55) + '...';
    }
    
    if (cleanText.length < 8) {
      return null;
    }
    
    return cleanText;
  }

  getBranchCount(complexity) {
    const counts = {
      'simple': 2,
      'medium': 3,
      'detailed': 4,
      'comprehensive': 5
    };
    return counts[complexity] || 3;
  }

  calculateConfidence(analysis) {
    if (!analysis) return 0.5;
    
    const sentenceCount = analysis.totalSentences || 0;
    const paragraphCount = analysis.totalParagraphs || 0;
    
    let confidence = 0;
    
    if (sentenceCount >= 3) confidence += 0.3;
    if (sentenceCount >= 8) confidence += 0.2;
    if (paragraphCount >= 2) confidence += 0.3;
    if (paragraphCount >= 4) confidence += 0.2;
    
    return Math.min(confidence, 0.95);
  }

  capitalizeFirst(text) {
    if (!text) return '';
    return text.charAt(0).toUpperCase() + text.slice(1);
  }

  // Gi·ªØ l·∫°i ph∆∞∆°ng th·ª©c c≈© ƒë·ªÉ t∆∞∆°ng th√≠ch
  determineCentralTopic(analysis) {
    return this.findTrueCentralTopic(analysis.sentences, analysis.keyPhrases);
  }
};

// Export function ch√≠nh (gi·ªØ nguy√™n)
exports.handler = async (event) => {
  // ... (gi·ªØ nguy√™n ph·∫ßn handler)
  // Code handler gi·ªØ nguy√™n nh∆∞ ban ƒë·∫ßu
};
